<!DOCTYPE html>
<html>
<head>
    <title>SQL命令执行器</title>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f5f6fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* 标题样式 */
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #eee;
        }

        /* SQL输入区域 */
        .input-section {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sql-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
            background: #f8f9fa;
        }

        .sql-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }

        /* 按钮样式 */
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .execute-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .execute-btn:hover {
            background: #2980b9;
        }

        .download-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            display: none;
        }

        .download-btn:hover {
            background: #219a52;
        }

        /* 加载动画 */
        .loading {
            display: none;
            color: #666;
            margin-left: 10px;
            font-size: 14px;
        }

        /* 结果区域 */
        .result-section {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .result {
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }

        /* 表格样式 */
        .result table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .result th {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
        }

        .result td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
            font-size: 14px;
        }

        .result tr:hover {
            background: #f8f9fa;
        }

        .result td.number {
            font-family: 'Consolas', monospace;
            color: #2980b9;
        }

        /* 示例区域 */
        .examples {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .examples h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .examples pre {
            background: white;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            border: 1px solid #e1e8ed;
        }

        /* 消息样式 */
        .error {
            background: #fff5f5;
            color: #e74c3c;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #fad7d7;
        }

        .success {
            background: #f0fff4;
            color: #27ae60;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #c6f6d5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SQL命令执行器</h1>
        
        <div class="input-section">
            <textarea class="sql-input" placeholder="在此输入SQL命令..."></textarea>
            <div class="button-group">
                <button class="execute-btn" onclick="executeSql()">执行</button>
                <button class="download-btn" onclick="downloadCSV()">下载CSV</button>
                <span class="loading">执行中...</span>
            </div>
        </div>

        <div class="result-section">
            <div id="message" style="display: none;"></div>
            <div class="result"></div>
        </div>

        <div class="examples">
            <h3>SQL命令示例：</h3>
            <pre>
# 创建表
CREATE TABLE Products (productName CHAR,price FLOAT,quantity INT)
CREATE TABLE Students (studentName CHAR,age INT,score FLOAT)

# 插入数据
INSERT INTO Products VALUES ('苹果', 5.5, 10)
INSERT INTO Products VALUES ('香蕉', 3.99, 20)
INSERT INTO Products VALUES ('橙子', 4.5, 15)

INSERT INTO Students VALUES ('张三', 18, 92.5)
INSERT INTO Students VALUES ('李四', 19, 88.5)
INSERT INTO Students VALUES ('王五', 18, 95.5)

# 查询数据
SELECT * FROM Products
SELECT productName,price FROM Products
SELECT * FROM Products WHERE productName = '苹果'
SELECT * FROM Products WHERE productName = '苹果' AND price = 5.5
SELECT * FROM Products WHERE quantity = 10 AND price = 5.5
SELECT * FROM Students WHERE age = 18 AND score = 95.5

# 更新数据
UPDATE Products SET price = 6.5 WHERE productName = '苹果'
UPDATE Students SET score = 95.5 WHERE studentName = '张三'

# 删除数据
DELETE FROM Products WHERE productName = '香蕉'

# 注意：
# - CHAR类型的值必须用引号：'值'
# - INT类型的值必须是整数且不带引号：18
# - FLOAT类型的值必须带小数点且不带引号：92.5
# - WHERE条件支持AND连接两个条件</pre>
        </div>
    </div>

    <!-- JavaScript代码保持不变 -->
    <script>
        // 添加下载CSV的函数
        function downloadCSV() {
            const result = window.queryResult;  // 从全局变量获取查询结果
            if (!result || !Array.isArray(result) || result.length === 0) return;

            // 获取列名
            const headers = result[0].map(([col, _]) => col);
            
            // 获取数据行
            const rows = result.map(row => row.map(([_, value]) => value));
            
            // 构建CSV内容
            let csvContent = '\ufeff';  // 添加BOM头
            csvContent += headers.join(',') + '\n';  // 添加表头
            csvContent += rows.map(row => 
                row.map(value => {
                    // 如果值包含逗号、引号或换行符，需要用引号包裹
                    if (value.toString().includes(',') || value.toString().includes('"') || value.toString().includes('\n')) {
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            ).join('\n');

            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'query_result.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            
            // 清理
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 修改executeSql函数，在显示查询结果时保存数据并显示下载按钮
        async function executeSql() {
            const sql = document.querySelector('.sql-input').value;
            const resultDiv = document.querySelector('.result');
            const loadingSpan = document.querySelector('.loading');
            const messageDiv = document.getElementById('message');
            
            if (!sql.trim()) {
                resultDiv.innerHTML = '<pre class="error">请输入SQL语句</pre>';
                return;
            }

            try {
                // 显示加载状态
                loadingSpan.style.display = 'inline';
                resultDiv.innerHTML = '';
                messageDiv.style.display = 'none';

                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (typeof data.result === 'string') {
                        const isError = data.result.includes('错误') || data.result.startsWith('错误:');
                        resultDiv.innerHTML = `<pre class="${isError ? 'error' : 'success'}">${data.result}</pre>`;
                        document.querySelector('.download-btn').style.display = 'none';  // 隐藏下载按钮
                    } else {
                        if (Array.isArray(data.result) && data.result.length > 0) {
                            // 保存查询结果到全局变量
                            window.queryResult = data.result;
                            
                            // 显示表格
                            let html = '<table>';
                            
                            // 表头 - 不要转换大小写
                            html += '<tr>';
                            data.result[0].forEach(([col, _]) => {
                                html += `<th style="text-transform: none;">${col}</th>`;  // 移除text-transform
                            });
                            html += '</tr>';
                            
                            // 数据行
                            data.result.forEach(row => {
                                html += '<tr>';
                                row.forEach(([_, value]) => {
                                    const isNumber = !isNaN(value) && value !== '';
                                    html += `<td class="${isNumber ? 'number' : ''}">${value}</td>`;
                                });
                                html += '</tr>';
                            });
                            
                            html += '</table>';
                            resultDiv.innerHTML = html;
                            
                            // 显示下载按钮
                            document.querySelector('.download-btn').style.display = 'inline-block';
                        } else {
                            resultDiv.innerHTML = '<pre>查询结果为空</pre>';
                            document.querySelector('.download-btn').style.display = 'none';  // 隐藏下载按钮
                        }
                    }
                } else {
                    resultDiv.innerHTML = `<pre class="error">${data.result}</pre>`;
                    document.querySelector('.download-btn').style.display = 'none';  // 隐藏下载按钮
                }
            } catch (error) {
                resultDiv.innerHTML = `<pre class="error">执行出错: ${error}</pre>`;
            } finally {
                loadingSpan.style.display = 'none';
            }
        }

        // 支持Ctrl+Enter执行SQL
        document.querySelector('.sql-input').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeSql();
            }
        });
    </script>
</body>
</html>