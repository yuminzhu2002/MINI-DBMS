# 数据库管理系统设计文档

## 1. 设计目标描述

### 1.1 核心问题
本系统设计关注以下核心问题：

1. **SQL语句解析与执行效率**
   - 实现高效的词法分析和语法分析
   - 优化SQL执行计划
   - 支持复杂查询操作

2. **数据一致性与并发控制**
   - 实现表级锁机制
   - 支持事务ACID特性
   - 处理并发访问冲突

3. **数据存储与管理**
   - 采用CSV文件存储方案
   - 实现高效的文件操作
   - 保证数据完整性

4. **用户界面交互**
   - 提供Web操作界面
   - 支持多语句执行
   - 实现结果可视化

### 1.2 参考产品分析
以SQLite为参考，分析其特点：

1. **轻量级设计**
   - 单文件数据库
   - 零配置部署
   - 内存占用小

2. **自给自足**
   - 无外部依赖
   - 跨平台支持
   - 嵌入式应用

3. **功能完整**
   - 支持标准SQL
   - ACID事务
   - 并发控制

## 2. 系统设计描述

### 2.1 静态图类

#### 2.1.1 类图设计

1. **SQL解析器类图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

class SQLLexer {
  +tokens: Set[str]
  +keywords: Dict[str, str]
  +tokenize(text: str)
}

class SQLParser {
  +names: Dict
  +data_dir: str
  +parse(tokens: Iterator)
  +validate_value_type(value, expected_type)
}

class SQLError {
  +message: str
}

class SQLSyntaxError {
  +message: str
}

class SQLTypeError {
  +message: str
}

SQLError <|-- SQLSyntaxError
SQLError <|-- SQLTypeError
@enduml
```

2. **数据管理类图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

class DBManager {
  +db_path: str
  +lock_manager: LockManager
  +current_transaction: Transaction
  +begin_transaction()
  +commit_transaction()
  +rollback_transaction()
}

class LockManager {
  -_locks: Dict[str, Lock]
  -_global_lock: Lock
  +acquire_lock(table_name: str)
  +release_lock(table_name: str)
}

class Transaction {
  +db_path: str
  +operations: List[TableOperation]
  +active: bool
  +add_operation(operation: TableOperation)
  +commit()
  +rollback()
}

DBManager "1" *-- "1" LockManager
DBManager "1" *-- "0..1" Transaction
@enduml
```

3. **SQL执行器类图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

class SQLExecutor {
  +data_dir: str
  +execute(statements: List[Any])
  -_execute_create_table(stmt: CreateTableStatement)
  -_execute_insert(stmt: InsertStatement)
  -_execute_select(stmt: SelectStatement)
  -_execute_update(stmt: UpdateStatement)
  -_execute_delete(stmt: DeleteStatement)
}

class Statement {
}

class CreateTableStatement {
  +table: Table
}

class InsertStatement {
  +table_name: str
  +values: List[Any]
}

Statement <|-- CreateTableStatement
Statement <|-- InsertStatement
SQLExecutor ..> Statement
@enduml
```

#### 2.1.2 对象图设计

1. **查询执行对象图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

object "SelectQuery" as query {
  tables = ["Products"]
  columns = ["productName", "price"]
  conditions = ["price > 5.0"]
}

object "ResultSet" as result {
  columns = ["productName", "price"]
  rows = [["苹果", "5.5"], ["香蕉", "6.0"]]
}

query --> result : produces
@enduml
```

2. **事务处理对象图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

object "Transaction" as trans {
  active = true
  operations = [op1, op2]
}

object "TableOperation" as op1 {
  operation_type = "modify"
  table_name = "Products"
  backup_path = "Products.bak"
}

object "TableOperation" as op2 {
  operation_type = "create"
  table_name = "Orders"
  is_new = true
}

trans o-- op1
trans o-- op2
@enduml
```

### 2.2 交互图类

#### 2.2.1 时序图设计

1. **SQL执行时序图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

participant Client
participant WebServer
participant SQLParser
participant SQLExecutor
participant DBManager

Client -> WebServer: 发送SQL请求
WebServer -> SQLParser: 解析SQL
SQLParser -> SQLExecutor: 执行语句
SQLExecutor -> DBManager: 管理数据
DBManager --> SQLExecutor: 返回结果
SQLExecutor --> WebServer: 返回执行结果
WebServer --> Client: 显示结果
@enduml
```

2. **事务处理时序图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

participant Client
participant DBManager
participant Transaction
participant LockManager

Client -> DBManager: 开始事务
DBManager -> Transaction: 创建事务
Transaction -> LockManager: 获取锁
LockManager --> Transaction: 锁获取成功
Transaction -> DBManager: 执行操作
DBManager -> Transaction: 提交事务
Transaction -> LockManager: 释放锁
DBManager --> Client: 事务完成
@enduml
```

#### 2.2.2 协作图设计

1. **查询处理协作图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

object Client
object Parser
object Executor
object Storage

Client -> Parser: 1.发送查询
Parser -> Executor: 2.解析结果
Executor -> Storage: 3.读取数据
Storage --> Executor: 4.返回数据
Executor --> Client: 5.返回结果
@enduml
```

2. **数据更新协作图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

object Client
object Transaction
object LockManager
object FileSystem

Client -> Transaction: 1.开始更新
Transaction -> LockManager: 2.请求锁
LockManager -> FileSystem: 3.锁定文件
FileSystem -> Transaction: 4.更新数据
Transaction -> Client: 5.完成更新
@enduml
```

### 2.3 行为图类

#### 2.3.1 活动图设计

1. **SQL处理活动图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

start
:接收SQL语句;
:词法分析;
:语法分析;
if (语法正确?) then (yes)
  :执行SQL;
  if (执行成功?) then (yes)
    :返回结果;
  else (no)
    :返回错误;
  endif
else (no)
  :返回语法错误;
endif
stop
@enduml
```

2. **事务处理活动图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

start
:开始事务;
:获取锁;
if (获取成功?) then (yes)
  :执行操作;
  if (操作成功?) then (yes)
    :提交事务;
  else (no)
    :回滚事务;
  endif
else (no)
  :返回错误;
endif
:释放锁;
stop
@enduml
```

#### 2.3.2 状态图设计

1. **事务状态图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

[*] --> Active
Active --> PartiallyCommitted: 执行完成
PartiallyCommitted --> Committed: 提交成功
PartiallyCommitted --> Failed: 提交失败
Failed --> Aborted: 回滚
Committed --> [*]
Aborted --> [*]
@enduml
```

2. **表锁状态图**
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

[*] --> Unlocked
Unlocked --> Shared: 获取共享锁
Shared --> Exclusive: 升级锁
Exclusive --> Unlocked: 释放锁
Shared --> Unlocked: 释放锁
@enduml
```

### 2.4 实现图类

#### 2.4.1 部署图设计
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

node "客户端" {
  [Web浏览器]
}

node "服务器" {
  [Flask服务器]
  [SQL解析器]
  [SQL执行器]
  [数据库管理器]
}

database "文件系统" {
  folder "数据目录" {
    [CSV文件]
  }
}

[Web浏览器] ..> [Flask服务器]: HTTP
[Flask服务器] ..> [SQL解析器]
[SQL解析器] ..> [SQL执行器]
[SQL执行器] ..> [数据库管理器]
[数据库管理器] ..> [CSV文件]
@enduml
```

#### 2.4.2 组件图设计
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

package "前端" {
  [Web界面]
}

package "后端" {
  [HTTP服务器]
  [SQL解析模块]
  [执行引擎]
  [存储引擎]
}

database "存储" {
  [CSV文件系统]
}

[Web界面] --> [HTTP服务器]
[HTTP服务器] --> [SQL解析模块]
[SQL解析模块] --> [执行引擎]
[执行引擎] --> [存储引擎]
[存储引擎] --> [CSV文件系统]
@enduml
```

### 2.5 补充设计图

#### 2.5.1 数据结构图
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

class Table {
  +name: str
  +columns: List[Column]
}

class Column {
  +name: str
  +data_type: DataType
}

class DataType {
  +CHAR
  +INT
  +FLOAT
}

Table "1" *-- "*" Column
Column "1" *-- "1" DataType
@enduml
```

#### 2.5.2 数据流图
```plantuml
@startuml
!define PLANTUML_SERVER https://www.plantuml.com/plantuml

[SQL输入] --> [词法分析器]
[词法分析器] --> [语法分析器]
[语法分析器] --> [语义分析器]
[语义分析器] --> [执行器]
[执行器] --> [文件系统]
[文件系统] --> [结果集]
@enduml
```

## 3. 关键设计说明

### 3.1 SQL解析器设计
1. 使用SLY库实现词法和语法分析
2. 支持标准SQL语法子集
3. 实现类型系统和语义检查

### 3.2 执行器设计
1. 实现基本SQL操作
2. 支持条件过滤和表连接
3. 实现结果集处理

### 3.3 存储引擎设计
1. 基于CSV文件存储
2. 实现表级锁机制
3. 支持事务日志

### 3.4 并发控制设计
1. 实现两阶段锁协议
2. 支持事务隔离级别
3. 死锁检测和预防

### 3.5 Web接口设计
1. RESTful API设计
2. 结果集格式化
3. 错误处理机制

## 4. 总结

本设计文档详细描述了一个基于Python的简单数据库管理系统的设计和实现。通过使用UML工具，我们从不同角度展示了系统的结构和行为：

1. 静态图类展示了系统的类结构和对象关系
2. 交互图类描述了系统组件间的消息传递
3. 行为图类展示了系统的动态特性
4. 实现图类说明了系统的物理部署
5. 补充设计图提供了额外的系统视图

系统的主要特点包括：
- 模块化设计
- 清晰的层次结构
- 完整的事务支持
- 可扩展的��构

通过这些设计，系统实现了一个功能完整、结构清晰的小型数据库管理系统。 